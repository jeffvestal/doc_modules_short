#!/bin/bash

echo "Wait for the Instruqt host bootstrap to finish"
while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the virtual machine"
    sleep 1
done

# explicitly source env vars
source /etc/profile.d/instruqt-env.sh

####################################################################### ENV CHECK

export GCSKEY_CE_INFRA_CONTAINERS=$GCSKEY_CE_INFRA_CONTAINERS

if [[ -z "$GCSKEY_CE_INFRA_CONTAINERS" ]]; then
    echo "GCSKEY_CE_INFRA_CONTAINERS is null"
    exit 1
fi

####################################################################### WAIT FOR K3S API

export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

wait_for_api() {
  local timeout="$1"
  echo "[k3s] Waiting for API server readiness (timeout ${timeout}s)..."
  for i in $(seq 1 "$timeout"); do
    if kubectl get --raw='/readyz' >/dev/null 2>&1; then
      echo "[k3s] API server is responding"
      return 0
    fi
    sleep 1
  done
  return 1
}

if ! wait_for_api 300; then
  echo "[k3s] API not ready after first wait; restarting k3s once..."
  sudo systemctl restart k3s || true
  sleep 5
  if ! wait_for_api 180; then
    echo "[k3s] ERROR: API server not ready after restart"
    exit 1
  fi
fi

echo "[k3s] Waiting for nodes to become Ready..."
kubectl wait --for=condition=Ready node --all --timeout=300s

####################################################################### WAIT FOR ELASTICSEARCH AND KIBANA

echo "[Workshop] Waiting for Elasticsearch and Kibana to be ready..."

ELASTICSEARCH_URL="${ELASTICSEARCH_URL:-http://localhost:9200}"
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-${ELASTIC_API_KEY}}"
KIBANA_URL_UI="${KIBANA_URL_UI:-${KIBANA_URL:-http://localhost:30001}}"

MAX_RETRIES=60
RETRY_COUNT=0

until curl -fsS ${ELASTICSEARCH_APIKEY:+-H "Authorization: ApiKey ${ELASTICSEARCH_APIKEY}"} "${ELASTICSEARCH_URL}/_cluster/health" >/dev/null 2>&1; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
    echo "[Workshop] ERROR: Elasticsearch did not become ready in time"
    exit 1
  fi
  echo "  ... waiting for Elasticsearch (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
  sleep 5
done

echo "[Workshop] ✓ Elasticsearch is ready"

until curl -fsS -H "Authorization: ApiKey ${ELASTICSEARCH_APIKEY}" "${KIBANA_URL_UI}/api/status" >/dev/null 2>&1; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
    echo "[Workshop] ERROR: Kibana did not become ready in time"
    exit 1
  fi
  echo "  ... waiting for Kibana (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
  sleep 5
done

echo "[Workshop] ✓ Kibana is ready"

####################################################################### RESTORE ELASTICSEARCH SNAPSHOT

echo "[Workshop] Restoring Elasticsearch snapshot..."

/opt/workshops/elastic-snapshot.sh \
    -p products_reviews_users \
    -b instruqt-workshop-snapshot-public \
    -c sa \
    -n repo1 \
    -s products_reviews_users_v01 \
    -g false || {
    echo "[Workshop] ⚠️  Could not restore snapshot, continuing..."
}

echo "[Workshop] ✓ Elasticsearch indices restored"

####################################################################### EXPOSE ENVIRONMENT VARIABLES

echo "[Workshop] Setting up environment variable endpoint..."
mkdir -p /opt/workshop-assets
cat > /opt/workshop-assets/env-server.py << 'EOF'
#!/usr/bin/env python3
from http.server import HTTPServer, BaseHTTPRequestHandler
import os

class EnvHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/env':
            env_vars = [
                f'ELASTICSEARCH_URL={os.getenv("ELASTICSEARCH_URL", "http://localhost:9200")}',
                f'ELASTICSEARCH_APIKEY={os.getenv("ELASTICSEARCH_APIKEY", os.getenv("ELASTIC_API_KEY", ""))}',
                f'KIBANA_URL={os.getenv("KIBANA_URL", "http://localhost:30001")}',
            ]
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write('\n'.join(env_vars).encode())
        else:
            self.send_response(404)
            self.end_headers()

if __name__ == '__main__':
    server = HTTPServer(('0.0.0.0', 9000), EnvHandler)
    server.serve_forever()
EOF

chmod +x /opt/workshop-assets/env-server.py
nohup python3 /opt/workshop-assets/env-server.py > /var/log/env-server.log 2>&1 &

####################################################################### COMPLETE

echo "========================================="
echo "[Workshop] setup-kubernetes-vm complete"
echo "========================================="
echo "Services:"
echo "  - Elasticsearch: ${ELASTICSEARCH_URL}"
echo "  - Kibana: ${KIBANA_URL_UI}"
echo "  - Environment vars: http://kubernetes-vm:9000/env"
echo "========================================="

