#!/bin/bash

####################################################################### WAIT FOR BOOTSTRAP

echo "Wait for the Instruqt host bootstrap to finish"
while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the virtual machine"
    sleep 1
done

# explicitly source env vars
source /etc/profile.d/instruqt-env.sh

####################################################################### INSTALL PYTHON (do this early, in parallel with ES wait)

echo "[Workshop] Installing Python dependencies..."
apt-get update -qq
apt-get install -y --no-install-recommends python3-pip python3-venv > /dev/null 2>&1 &
APT_PID=$!

####################################################################### WAIT FOR KUBERNETES-VM SETUP TO COMPLETE

echo "[Workshop] Waiting for kubernetes-vm setup to expose environment..."
MAX_ENV_RETRIES=180
ENV_RETRY_COUNT=0

until curl -fsS "http://kubernetes-vm:9000/env" >/dev/null 2>&1; do
  ENV_RETRY_COUNT=$((ENV_RETRY_COUNT + 1))
  if [ $ENV_RETRY_COUNT -ge $MAX_ENV_RETRIES ]; then
    echo "[Workshop] ERROR: kubernetes-vm env server not ready after ${MAX_ENV_RETRIES} attempts"
    break
  fi
  echo "  ... waiting for kubernetes-vm setup (attempt ${ENV_RETRY_COUNT}/${MAX_ENV_RETRIES})"
  sleep 5
done

####################################################################### FETCH ENV VARS

echo "[Workshop] Fetching env vars from kubernetes-vm:9000/env..."
export $(curl -s http://kubernetes-vm:9000/env | xargs)

ELASTICSEARCH_URL="${ELASTICSEARCH_URL:-http://kubernetes-vm:30920}"
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-}"

# Wait for Elasticsearch
echo "[Workshop] Waiting for Elasticsearch..."
MAX_RETRIES=120
RETRY_COUNT=0

until curl -fsS ${ELASTICSEARCH_APIKEY:+-H "Authorization: ApiKey ${ELASTICSEARCH_APIKEY}"} "${ELASTICSEARCH_URL}/_cluster/health" >/dev/null 2>&1; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
    echo "[Workshop] ERROR: Elasticsearch not ready after ${MAX_RETRIES} attempts"
    break
  fi
  echo "  ... waiting for Elasticsearch (attempt ${RETRY_COUNT}/${MAX_RETRIES})"
  sleep 5
done

echo "[Workshop] ✓ Elasticsearch is reachable"

# Quick Kibana check (non-blocking, just informational)
if curl -fsS "http://kubernetes-vm:30001/api/status" >/dev/null 2>&1; then
  echo "[Workshop] ✓ Kibana is reachable"
else
  echo "[Workshop] ⚠️  Kibana not ready yet (will continue)"
fi

####################################################################### DOWNLOAD WORKSHOP ASSETS

echo "[Workshop] Downloading workshop assets from GitHub..."
cd /opt
rm -rf workshop-assets temp-repo

# Clone only what we need (backend with pre-built static assets)
echo "[Workshop] Cloning repository..."
if git clone --depth 1 --filter=blob:none --sparse https://github.com/jeffvestal/doc_modules_short.git temp-repo; then
  cd temp-repo
  git sparse-checkout set shared/backend
  cd /opt
  
  mkdir -p workshop-assets
  cp -r temp-repo/shared/backend /opt/workshop-assets/
  rm -rf temp-repo
  echo "[Workshop] ✓ Backend with pre-built frontend copied"
else
  echo "[Workshop] ✗ ERROR: Could not clone repository!"
  exit 1
fi

# Use lab-specific static folder
echo "[Workshop] Setting up Prefix Query lab frontend..."
STATIC_FOLDER="/opt/workshop-assets/backend/static-prefix-query"
if [ -d "${STATIC_FOLDER}" ]; then
  rm -rf /opt/workshop-assets/backend/static
  mv "${STATIC_FOLDER}" /opt/workshop-assets/backend/static
  echo "[Workshop] ✓ Prefix Query frontend configured"
else
  echo "[Workshop] ⚠️  Lab-specific static folder not found, using default"
fi

# Verify pre-built frontend assets exist
if [ -f "/opt/workshop-assets/backend/static/index.html" ]; then
  echo "[Workshop] ✓ Pre-built frontend assets found"
else
  echo "[Workshop] ✗ ERROR: Pre-built frontend assets not found!"
  exit 1
fi

####################################################################### SET ENVIRONMENT VARIABLES

export ELASTICSEARCH_URL="http://kubernetes-vm:30920"
export KIBANA_URL="http://kubernetes-vm:30001"
export ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-${ELASTIC_API_KEY}}"

cat > /opt/workshop-assets/backend/.env << EOF
ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
ELASTICSEARCH_APIKEY=${ELASTICSEARCH_APIKEY}
EOF

####################################################################### SETUP BACKEND

# Wait for apt to finish if still running
wait $APT_PID 2>/dev/null

echo "[Workshop] Setting up Python backend..."
cd /opt/workshop-assets/backend

python3 -m venv venv
source venv/bin/activate
pip install --quiet --no-cache-dir --upgrade pip
pip install --quiet --no-cache-dir -r requirements.txt

# Start backend
echo "[Workshop] Starting backend server..."
ELASTICSEARCH_URL="${ELASTICSEARCH_URL}" \
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY}" \
nohup /opt/workshop-assets/backend/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/backend.log 2>&1 &

deactivate

####################################################################### VERIFY SERVICES

echo "[Workshop] Waiting for backend to be healthy..."
for i in $(seq 1 20); do
  if curl -fsS http://localhost:8000/health >/dev/null 2>&1; then
    echo "[Workshop] ✓ Backend is running and healthy"
    break
  fi
  sleep 2
done

# Quick frontend check
if curl -fsS http://localhost:8000/ | grep -q "html" 2>/dev/null; then
  echo "[Workshop] ✓ Frontend is being served"
fi

####################################################################### COMPLETE

echo "========================================="
echo "[Workshop] ✓ Setup complete"
echo "  Query Lab: http://host-1:8000"
echo "========================================="
